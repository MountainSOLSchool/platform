<div style="margin-bottom: 2rem">
    <div
        class="p-input-icon-left"
        style="margin-left: auto; margin-right: auto"
    >
        <i class="pi pi-search"></i>
        <span class="p-input-icon-right">
            <i
                *ngIf="searchInput.value.length > 0"
                class="pi pi-times-circle"
                (click)="searchChange((searchInput.value = ''))"
                style="cursor: pointer"
            ></i>
            <input
                #searchInput
                type="text"
                pInputText
                placeholder="Search"
                style="width: 400px"
                (input)="searchChange(searchInput.value)"
            />
        </span>
    </div>
    <div style="display: inline; margin-left: 1rem">
        <p-dropdown
            [options]="(filterOptions$ | async) ?? []"
            placeholder="Select a grade range"
            optionLabel="name"
            [showClear]="true"
            (onChange)="filterChange($event.value?.value ?? [])"
        ></p-dropdown>
    </div>
</div>
<div
    *rxLet="selectedClasses$; let selected"
    style="
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        background: white;
        padding: 0.5rem 0 1rem 0;
        z-index: 1;
        border-bottom: 1px solid lightgray;
    "
>
    <p>
        <b>Selected classes ({{ selected?.length ?? 0 }})</b>
    </p>
    <div style="display: flex; gap: 4px; flex-wrap: wrap">
        <div *rxFor="let class of selected; trackBy: trackClassCard">
            <p-chip
                [label]="class.title"
                [removable]="true"
                (onRemove)="selectionChanged({ id: class.id, selected: false })"
            ></p-chip>
        </div>
    </div>
</div>

<div
    *rxIf="isFakeSearchLoading$; else classList"
    style="width: 100%; margin-top: 1rem"
>
    <div style="margin-left: auto; margin-right: auto; width: fit-content">
        <p-progressSpinner></p-progressSpinner>
    </div>
</div>
<ng-template #classList>
    <div style="margin-top: 1rem">
        <ng-container
            *rxLet="filteredClassRows$; let classRows; suspense: skeleton"
        >
            <ng-container *ngIf="classRows.length > 0; else noResults">
                <div
                    style="border-radius: 5px; margin: 2px; padding: 5px"
                    [ngStyle]="{}"
                    *rxFor="let row of classRows; trackBy: trackClassRow"
                >
                    <ng-container *rxIf="!!row.group">
                        <h3>
                            {{ row.group?.name }}
                            <span
                                *ngIf="getClassRowSavings(row) !== 0"
                                style="color: #3c82f7"
                            >
                                (-{{ getClassRowSavings(row) | currency }}
                                all-day discount)
                            </span>
                        </h3>

                        <div
                            style="
                                margin-top: 1rem;
                                margin-bottom: 1rem;
                                margin-left: 1rem;
                            "
                        >
                            <p-toggleButton
                                [inputId]="'select' + row.group?.id"
                                [name]="'row_' + row.group?.id"
                                onIcon="pi pi-check"
                                onLabel="Selected all"
                                offIcon="pi pi-plus"
                                offLabel="Select all"
                                [ngModel]="row.selected"
                                (ngModelChange)="
                                    rowSelectedChange(row, !row.selected)
                                "
                            ></p-toggleButton>
                        </div>
                    </ng-container>
                    <div
                        *rxFor="
                            let class of row.classes;
                            trackBy: trackClassCard
                        "
                        [ngStyle]="{
                            width: '40rem',
                            border: class.selected
                                ? '.2rem solid #3c82f7'
                                : '.2rem solid transparent',
                            'box-sizing': 'border-box',
                            'border-radius': '6px',
                            'margin-bottom': '2em',
                            'margin-left': 'auto',
                            'margin-right': 'auto',
                            display: 'inline-block'
                        }"
                    >
                        <p-card [styleClass]="'gradient'">
                            <ng-template pTemplate="header"></ng-template>
                            <div
                                style="position: relative; margin-top: -2.5rem"
                            >
                                <h2>{{ class.title }}</h2>
                                <img
                                    *rxIf="class.thumbnailUrl !== ''"
                                    alt="Card"
                                    [src]="class.thumbnailUrl"
                                    style="
                                        position: absolute;
                                        top: 0px;
                                        right: 0px;
                                        border-radius: 6px;
                                    "
                                    height="150"
                                    width="150"
                                />
                            </div>
                            <div
                                class="flex align-items-center"
                                style="margin-bottom: 1.5rem; margin-top: 1rem"
                            >
                                <p-tag
                                    [value]="class.classDateTimes"
                                    icon="pi pi-calendar"
                                    styleClass="mr-2"
                                ></p-tag>
                                <p-tag
                                    [value]="class.weekday"
                                    styleClass="mr-2"
                                ></p-tag>
                                <p-tag
                                    [value]="class.dailyTimes"
                                    icon="pi pi-clock"
                                    styleClass="mr-2"
                                ></p-tag>
                            </div>
                            <p>
                                <b>Class Type:</b> {{ class.classType }}<br />
                                <b>Grades:</b>
                                {{ class.gradeRangeStart }} -
                                {{ class.gradeRangeEnd }}<br />
                                <b>Location:</b> {{ class.location }}<br />
                                <b>Cost:</b> ${{ class.cost }}<br />
                                <b>Instructors:</b>
                                <span
                                    *rxFor="
                                        let instructor of class.instructors;
                                        let isLast = last
                                    "
                                >
                                    {{ instructor.firstName }}
                                    {{ instructor.lastName
                                    }}{{ isLast ? '' : ', ' }}
                                </span>
                                <br />
                                <br />
                                <b>Description:</b> <br />
                                {{ class.description }}<br />
                            </p>
                            <div style="margin-top: 2rem; margin-bottom: -1rem">
                                <p-toggleButton
                                    [inputId]="'select' + class.id"
                                    onIcon="pi pi-check"
                                    onLabel="Selected"
                                    offIcon="pi pi-plus"
                                    offLabel="Select"
                                    [(ngModel)]="class.selected"
                                    (ngModelChange)="selectionChanged(class)"
                                ></p-toggleButton>
                            </div>
                        </p-card>
                    </div>
                </div> </ng-container
            ><ng-template #noResults>
                There are no classes for the current search.
            </ng-template></ng-container
        >
    </div>
</ng-template>
<ng-template #skeleton>
    <div *rxFor="let i of [1, 2, 3]" class="custom-skeleton p-4">
        <div class="flex mb-3">
            <p-skeleton
                shape="circle"
                size="4rem"
                styleClass="mr-2"
            ></p-skeleton>
            <div>
                <p-skeleton width="10rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="5rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton height=".5rem"></p-skeleton>
            </div>
        </div>
        <p-skeleton width="100%" height="150px"></p-skeleton>
        <div class="flex justify-content-between mt-3">
            <p-skeleton width="4rem" height="2rem"></p-skeleton>
            <p-skeleton width="4rem" height="2rem"></p-skeleton>
        </div>
    </div>
</ng-template>
