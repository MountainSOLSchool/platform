name: Check builds on PR

on:
    pull_request:
        branches:
            - '**'

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        if: github.repository == 'MountainSOLSchool/platform'
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'
            - run: npm ci
            - run: npx nx run enrollment-portal:build:production
            - run: npx nx run student-portal:build:production
            - run: npx nx run functions:build

    storybook:
        name: Storybook Build & Tests
        runs-on: ubuntu-latest
        if: github.repository == 'MountainSOLSchool/platform'
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'
            - run: npm ci
            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium
            - name: Build Storybook
              run: npx nx run enrollment-portal:build-storybook
            - name: Serve Storybook and run interaction tests
              run: |
                  npx concurrently -k -s first -n "SB,TEST" \
                    "npx http-server dist/storybook/enrollment-portal --port 6006 --silent" \
                    "npx wait-on tcp:6006 && npx test-storybook --config-dir apps/enrollment-portal/.storybook --url http://localhost:6006 --ci"

    integration-tests:
        name: Firebase Integration Tests
        runs-on: ubuntu-latest
        if: github.repository == 'MountainSOLSchool/platform'
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'npm'
            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '21'
            - run: npm ci
            - name: Build functions
              run: npx nx run functions:build
            - name: Run integration tests with emulators
              run: npx firebase emulators:exec --project=dev --only auth,firestore,functions "npx nx run functions-integration-tests:test"
